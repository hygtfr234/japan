import React, { useState, useEffect } from 'react';
import { MapPin, Navigation, Info, Sun, Cloud, CloudRain, Snowflake, CloudFog, AlertCircle, RefreshCw } from 'lucide-react';

/**
 * æ¥“ä¹‹è°·é¢¨æ ¼å››åœ‹æ—…éŠ App V3.0 (å…¬æœƒå»£æ’­æ•´åˆç‰ˆ)
 * Updates:
 * 1. æ•´åˆä½¿ç”¨è€…æä¾›çš„è©³ç´°è¡Œç¨‹é€£çµ (Toyota, æ¶®ä¹ƒè‘‰, çƒé¾éºµå­¸æ ¡...)
 * 2. æ–°å¢ Info é é¢çš„æ‹‰åœ–æ–¯ã€æ‰å¯¶å‹•ç•«èˆ‡ç¶“å…¸å°è©±è¦–çª—
 * 3. ä¿®æ­£ Day 5 èªæ³•éŒ¯èª¤ä¸¦åŠ å…¥è¡Œç¨‹
 * 4. å°èˆªåœ–ç¤ºå…¨é¢æ›´æ–°ç‚ºã€Œå›å®¶å·è»¸ã€
 */

// --- å¸¸æ•¸è¨­å®š ---

// æ¥“ä¹‹è°·é¢¨æ ¼åœ–ç¤º
const ICONS = {
  slime: "https://maplestory.io/api/gms/62/mob/1210100/render/move?center=true", // ç¶ æ°´éˆ
  mushroom: "https://maplestory.io/api/gms/62/mob/1210102/render/move?center=true", // è‡è‡å¯¶è²
  papulatus: "https://maplestory.io/api/gms/62/mob/8500001/render/move?center=true", // æ‹‰åœ–æ–¯
  returnScroll: "https://maplestory.io/api/gms/62/item/2030000/icon", // å›å®¶å·è»¸ (å°èˆªç”¨)
  
  // æ‰è½ç‰©
  chaosScroll: "https://maplestory.io/api/gms/62/item/2049100/icon", // æ··æ²Œå·è»¸
  zakumHelm: "https://maplestory.io/api/gms/62/item/1002357/icon", // ç‚é­”é ­ç›”
  ilbi: "https://maplestory.io/api/gms/62/item/2070006/icon", // æ—¥ä¹‹é¢
};

// è¡Œç¨‹è³‡æ–™ (å·²æ•´åˆä½¿ç”¨è€…æä¾›çš„é€£çµèˆ‡å…§å®¹)
const itineraryData = [
  {
    day: 1,
    title: "Day 1ï½œæŠµé”é«˜æ¾",
    subTitle: "é«˜æ¾",
    date: "1/23 (äº”)",
    locationName: "Takamatsu",
    lat: 34.3428, lng: 134.0466,
    note: "å°å¿ƒé§•é§›!é€™è£¡ç¦æ­¢è³½æ©æ”¾Rã€‚é©æ‡‰å³é§•ï¼Œå¥½å¥½ä¼‘æ¯ï¼",
    events: [
      { 
        time: "07:00", 
        title: "CI278 æ¡ƒåœ’èµ·é£›", 
        desc: "å‰å¾€é«˜æ¾ï¼Œå†’éšªé–‹å§‹ï¼(A321neo)", 
        icon: 'plane',
        image: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/B-18101_A21N_China_Airlines_TPE_20211202.jpg/800px-B-18101_A21N_China_Airlines_TPE_20211202.jpg"
      },
      { time: "10:20", title: "æŠµé”é«˜æ¾ç©ºæ¸¯", desc: "å…¥å¢ƒã€å‰å¾€ Toyota ç§Ÿè»Š", icon: 'car', link: "https://maps.app.goo.gl/nuF1de38tVXAUcE97" },
      { time: "12:00", title: "ç§Ÿè»Š & åˆé¤", desc: "æ¶®ä¹ƒè‘‰ (åƒé£½å‡ºç™¼)", icon: 'food', link: "https://maps.app.goo.gl/KdNuojGtmtbTNwVn7" },
      { time: "13:30", title: "æ —æ—å…¬åœ’", desc: "ç±³å…¶æ—ä¸‰æ˜Ÿåº­åœ’ (2H)", icon: 'sight', link: "https://maps.app.goo.gl/7RyaPV2mX3qwtdCF6" },
      { time: "17:30", title: "å•†åº—è¡—æ•£ç­–", desc: "å…«å¤§æ¢å•†åº—è¡—è‡ªç”±é€›", icon: 'shop', link: "https://maps.app.goo.gl/WtpDx59qEmA7GaCD6" },
      { time: "18:30", title: "Vent Buffet", desc: "æ™šé¤æ™‚å…‰", icon: 'dinner', link: "https://maps.app.goo.gl/Kyw7DE3dBXLbcfbr5" }
    ]
  },
  {
    day: 2,
    title: "Day 2ï½œD2é«˜æ¾",
    subTitle: "é«˜æ¾",
    date: "1/24 (å…­)",
    locationName: "Takamatsu",
    lat: 34.3428, lng: 134.0466,
    note: "é¯Šé­šç‰ŒVPNå¥½ç”¨ï¼Œå°å¿ƒé†£æšˆã€‚",
    events: [
      { time: "10:00", title: "Uniqloè³¼ç‰©", desc: "é‚„æˆ‘æŠ€èƒ½æ›¸", icon: 'shop', link: "https://maps.app.goo.gl/5kb8Zbv7AMxdfkAY8" },
      { time: "14:30", title: "ä¸­é‡çƒå†¬éºµå­¸æ ¡", desc: "æ‰‹ä½œçƒé¾éºµé«”é©—", icon: 'noodle', link: "https://maps.app.goo.gl/hrhZYqad8Z5QgViQA" },
    ]
  },
  {
    day: 3,
    title: "Day 3ï½œå°è±†å³¶",
    subTitle: "å°è±†å³¶",
    date: "1/25 (æ—¥)",
    locationName: "Shodoshima",
    lat: 34.4950, lng: 134.2706,
    note: "æ ¹æ“šç•¶å¤©é«”åŠ›å’Œå¤©æ°£ï¼Œåˆ‡æ›ä¸Šæ–¹æŒ‰éˆ•é¸æ“‡è¡Œç¨‹ï¼",
    hasVariants: true,
    eventsMain: [
      { time: "10:00", title: "é«˜æ¾æ¸¯ â†’ åœŸåº„æ¸¯", desc: "11:10æ­ä¹˜æ¸¡è¼ª (ç´„1H)", icon: 'boat', link: "https://maps.app.goo.gl/3197KYMnoQUJgDnC9" },
      { time: "12:10", title: "æ©„æ¬–å…¬åœ’", desc: "é­”å¥³å®…æ€¥ä¾¿æƒå¸šæ‹ç…§", icon: 'sight', link: "https://maps.app.goo.gl/2FRV2NFN67UiiF7z5" },
      { time: "15:30", title: "é†¬ä¹‹é„‰", desc: "ä¸¸é‡‘é†¬æ²¹ç´€å¿µé¤¨", icon: 'ice', link: "https://maps.app.goo.gl/AGoWGLM66ryZpmx47" },
      { time: "16:00", title: "å¤©ä½¿ä¹‹è·¯", desc: "é€€æ½®æ²™ç˜æ•£æ­¥", icon: 'sight', link: "https://maps.app.goo.gl/GKXp6L2afkPf11m68" },
      { time: "18:00", title: "åœŸåº„æ¸¯ â†’ é«˜æ¾æ¸¯", desc: "16:25 / 18:00 / 19:00 çš†å¯", icon: 'boat', link: "https://maps.app.goo.gl/hprFCKkvTNSrXRT27" }
    ],
    eventsBackup: [
      { time: "09:00", title: "å‰å¾€ç”·æœ¨å³¶", desc: "é«˜æ¾æ¸¯æ­èˆ¹å‰å¾€", icon: 'boat', link: "https://maps.app.goo.gl/3197KYMnoQUJgDnC9" },
      { time: "10:00", title: "ç”·æœ¨å³¶ (è²“å³¶)", desc: "è±ç‰å§¬ç¥ç¤¾ã€æ“¼è²“æ•£æ­¥", icon: 'cat', link: "https://maps.app.goo.gl/b2vevyKvApfrHUkJ9" },
      { time: "13:00", title: "ç”·æœ¨æ¸¯ â†’ é«˜æ¾æ¸¯", desc: "è¿”å›å¸‚å€", icon: 'boat', link: "https://maps.app.goo.gl/Soefr2nUzymefXqdA" },
      { time: "15:00", title: "å®¤å…§è¡Œç¨‹", desc: "å•†åº—è¡— / å’–å•¡å»³ä¼‘æ¯", icon: 'coffee', link: "https://maps.app.goo.gl/yVYtBP5ktURNsApz7" }
    ]
  },
  {
    day: 4,
    title: "Day 4ï½œå€‰æ•·",
    subTitle: "å€‰æ•·",
    date: "1/26 (ä¸€)",
    locationName: "Kurashiki",
    lat: 34.5951, lng: 133.7667,
    note: "æˆ‘åªæ˜¯æ‡¶å¾—æŠŠé€™é åˆªé™¤ (è¨˜å¾—ç•™è‚šå­åƒç”œé»)",
    hasVariants: true,
    eventsMain: [
      { time: "09:00", title: "å€‰æ•·ç¾è§€åœ°å€", desc: "é‹æ²³éŠèˆ¹ã€å¤è¡—æ•£æ­¥", icon: 'sight', link: "https://maps.app.goo.gl/MCqK6jsAX4tsC22L6" },
      { time: "12:00", title: "å¤å¸‚çƒé¾éºµ", desc: "åˆé¤æ¨è–¦", icon: 'noodle', link: "https://maps.app.goo.gl/KeZqCFvzyRBpykA16" },
      { time: "12:00", title: "èŒ¶å±‹å¤§æ©‹", desc: "æ°´æœè–ä»£ (çƒé¾éºµæ—)", icon: 'ice', link: "https://maps.app.goo.gl/krTbwdcA1MFKwRNE7" },
      { time: "14:00", title: "å››åœ‹æ°´æ—é¤¨", desc: "æ–°æ™¯é»æ¨è–¦", icon: 'fish', link: "https://maps.app.goo.gl/NFAziUMgPVTiQaUG8" },
      { time: "18:00", title: "ç‡’è‚‰King", desc: "æ™šé¤åƒåˆ°é£½", icon: 'food', link: "https://maps.app.goo.gl/rgRU61HuEUkQLNts9" }
    ],
    eventsBackup: [
       { time: "09:00", title: "æ»¿æ¿ƒå…¬åœ’", desc: "å‚™ç”¨æ™¯é»", icon: 'sight', link: "https://maps.app.goo.gl/ZWPQL29vTGX4pNRN7" }
    ]
  },
  {
    day: 5,
    title: "Day 5ï½œé‡‘åˆ€æ¯”ç¾…/è¿”ç¨‹",
    subTitle: "è¿”ç¨‹",
    date: "1/27 (äºŒ)",
    locationName: "Takamatsu Airport",
    lat: 34.2142, lng: 134.0157,
    note: "HPè—¥æ°´å·²è€—ç›¡ï¼Œå¯µç‰©å°‡ç¦æ­¢æ‚¨æ˜æ—¥ä¸Šç­ä¸Šèª²ã€‚",
    events: [
      { time: "09:00", title: "é‡‘åˆ€æ¯”ç¾…å®®", desc: "æŒ‘æˆ°1368éšæ¢¯ï¼Œåƒæ‹œç‹—ç‹—ç¥", icon: 'shrine', link: "https://maps.app.goo.gl/pksTiU7nz1dW48D8A" },
      { time: "12:30", title: "å±±è¶Šçƒé¾éºµ", desc: "çƒé¾éºµååº—åˆé¤", icon: 'noodle', link: "https://maps.app.goo.gl/4UgroFhDnHTfAA2UA" },
      { time: "14:15", title: "é«˜æ¾ç©ºæ¸¯", desc: "èˆªå»ˆå‰ç¦æ­¢åœè»Šï¼Œåœè»Šå ´ä¸€å°æ™‚å…è²»", icon: 'plane', link: "https://maps.app.goo.gl/Jrke3gQWvT8z95vP6" },
      { time: "14:30", title: "é‚„è»Š", desc: "å‰å¾€ Toyota ç§Ÿè»Š", icon: 'car', link: "https://maps.app.goo.gl/ZWPQL29vTGX4pNRN7" },
      { time: "18:55", title: "èµ·é£›è¿”å°", desc: "Bye Bye!", icon: 'plane' }
    ]
  }
];

// --- è¼”åŠ©å…ƒä»¶ ---

// çœŸå¯¦å¤©æ°£é¡¯ç¤ºå…ƒä»¶
const RealWeather = ({ lat, lng, locationName }) => {
  const [weatherData, setWeatherData] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  useEffect(() => {
    const fetchWeather = async () => {
      setLoading(true);
      setError(false);
      try {
        const response = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo`
        );
        if (!response.ok) throw new Error('Weather fetch failed');
        const data = await response.json();
        setWeatherData(data);
      } catch (err) {
        console.error(err);
        setError(true);
      } finally {
        setLoading(false);
      }
    };

    fetchWeather();
  }, [lat, lng]);

  if (loading) return <div className="text-xs animate-pulse text-blue-600 font-bold">è®€å–è¡›æ˜Ÿé›²åœ–ä¸­...</div>;
  if (error) return <div className="text-xs text-red-500">æ°£è±¡é€£ç·šä¸­æ–·</div>;
  if (!weatherData) return null;

  const current = weatherData.current_weather;
  const daily = weatherData.daily;
  const code = current?.weathercode;
  const maxTemp = daily?.temperature_2m_max?.[0] ? Math.round(daily.temperature_2m_max[0]) : '-';
  const minTemp = daily?.temperature_2m_min?.[0] ? Math.round(daily.temperature_2m_min[0]) : '-';
  const rainProb = daily?.precipitation_probability_max?.[0] ?? 0;

  let Icon = Sun;
  let statusText = "æ™´æœ—";
  let colorClass = "text-orange-500";

  if (code >= 71) { Icon = Snowflake; statusText = "ä¸‹é›ª"; colorClass = "text-blue-300"; }
  else if (code >= 51) { Icon = CloudRain; statusText = "æœ‰é›¨"; colorClass = "text-blue-600"; }
  else if (code >= 45) { Icon = CloudFog; statusText = "æœ‰éœ§"; colorClass = "text-gray-400"; }
  else if (code >= 1) { Icon = Cloud; statusText = "å¤šé›²"; colorClass = "text-gray-500"; }

  return (
    <div className="bg-gradient-to-r from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-3 flex justify-between items-center shadow-sm">
      <div className="flex flex-col">
        <span className="text-xs font-bold text-blue-800 mb-1">ğŸ“ {locationName}</span>
        <span className="text-sm font-bold text-gray-700">{statusText} (é™é›¨ {rainProb}%)</span>
        <span className="text-xs text-gray-500">H:{maxTemp}Â° / L:{minTemp}Â°</span>
      </div>
      <div className="flex flex-col items-center">
        <Icon className={`w-8 h-8 ${colorClass}`} />
        <span className="text-xl font-black text-gray-800 leading-none mt-1">{Math.round(current?.temperature ?? 0)}Â°</span>
      </div>
    </div>
  );
};

// ç¶“é©—å€¼æ¢å…ƒä»¶
const ExpBar = ({ day, totalDays = 5, isInfo }) => {
  const percentage = Math.min(100, Math.round((day / totalDays) * 100));
  
  if (isInfo) {
      return (
        <div className="fixed bottom-0 left-0 right-0 bg-[#2b2b2b] border-t-2 border-[#FFD700] h-9 flex items-center justify-center z-50 overflow-hidden">
             {/* å½©è™¹è·‘é¦¬ç‡ˆ */}
             <style>{`
               @keyframes rainbow { 
                   0% { color: #ff0000; } 15% { color: #ff7f00; } 30% { color: #ffff00; } 
                   45% { color: #00ff00; } 60% { color: #0000ff; } 75% { color: #4b0082; } 100% { color: #9400d3; }
               }
             `}</style>
             <span className="font-bold text-sm" style={{ animation: 'rainbow 2s linear infinite', textShadow: '1px 1px 0 #000' }}>
                 [å»£æ’­] on9ayæ‹›ç”Ÿä¸­
             </span>
        </div>
      )
  }

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-[#333] border-t-2 border-[#555] h-10 flex items-center px-3 z-50">
      <span className="text-[#FFCC00] font-black text-xs mr-2 drop-shadow-md">EXP</span>
      <div className="flex-1 h-3 bg-[#111] rounded-full overflow-hidden border border-[#555] relative">
        <div 
          className="h-full bg-gradient-to-b from-[#00ff00] to-[#00cc00] transition-all duration-1000 ease-out"
          style={{ width: `${percentage}%` }}
        ></div>
        <div className="absolute top-0 left-0 right-0 h-1/2 bg-white opacity-20"></div>
      </div>
      <span className="text-white text-xs ml-2 font-mono">{percentage}%</span>
    </div>
  );
};

// --- ä¸»ç¨‹å¼ ---

export default function ShikokuAdventureV2() {
  const [activeDay, setActiveDay] = useState(1);
  const [day3Mode, setDay3Mode] = useState('main');
  const [day4Mode, setDay4Mode] = useState('main'); // æ–°å¢ Day 4 åˆ‡æ›
  const [showInfo, setShowInfo] = useState(false);

  const currentData = itineraryData.find(d => d.day === activeDay);
  
  let displayEvents = [];
  if (currentData) {
    if (currentData.hasVariants) {
        if (currentData.day === 3) {
            displayEvents = day3Mode === 'backup' ? currentData.eventsBackup : currentData.eventsMain;
        } else if (currentData.day === 4) {
            displayEvents = day4Mode === 'backup' ? currentData.eventsBackup : currentData.eventsMain;
        }
    } else {
      displayEvents = currentData.events;
    }
  }

  const safeEvents = displayEvents || [];

  const handleNavigate = (link) => {
      // å¦‚æœé€£çµå­˜åœ¨æ‰é–‹å•Ÿ
      if (link) window.open(link, '_blank');
  };

  return (
    <>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+TC:wght@900&display=swap');
        body { font-family: 'M PLUS Rounded 1c', sans-serif; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes bounceDrop { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
      `}</style>

      <div className="min-h-screen bg-[#87CEEB] pb-16" 
           style={{
             backgroundImage: "url('https://i.pinimg.com/originals/1e/86/82/1e8682d029094054a138c2084c83091e.jpg')",
             backgroundSize: 'cover',
             backgroundAttachment: 'fixed',
             backgroundPosition: 'center bottom'
           }}>
        
        {/* æ¨¡æ“¬æ¥“ä¹‹è°·è¦–çª—å®¹å™¨ */}
        <div className="max-w-xl mx-auto mt-2 bg-white rounded-xl overflow-hidden shadow-2xl border-4 border-[#8B4513]">
          
          {/* è¦–çª—æ¨™é¡Œåˆ— */}
          <div className="bg-gradient-to-b from-[#4b6cb7] to-[#182848] p-3 flex justify-between items-center border-b-4 border-[#DAA520]">
            <div className="flex items-center gap-2">
              <img src={ICONS.slime} alt="icon" className="w-10 h-10 object-contain drop-shadow-lg animate-bounce" />
              <h1 className="text-white font-black text-lg drop-shadow-md tracking-wide">è³œåœ‹ç©å››åœ‹</h1>
            </div>
            <div className="bg-black/30 px-2 py-1 rounded text-white text-xs font-mono border border-white/20">
              Lv. 2026 æ—¥æœ¬å››åœ‹åˆå¿ƒè€…
            </div>
          </div>

          {/* Tabs å°èˆª (æ›´æ–°é¡è‰²) */}
          <div className="flex bg-[#6D4C41] border-b-2 border-[#3E2723] overflow-x-auto scrollbar-hide">
            {itineraryData.map(d => (
              <button
                key={d.day}
                onClick={() => { setActiveDay(d.day); setShowInfo(false); }}
                className={`flex-1 min-w-[70px] py-2 px-1 flex flex-col items-center justify-center border-r border-[#4E342E] transition-colors
                  ${!showInfo && activeDay === d.day 
                    ? 'bg-white text-[#3E2723] shadow-[inset_0_-4px_0_#FFCC00]' 
                    : 'bg-gradient-to-b from-[#8D6E63] to-[#5D4037] text-[#DDD] hover:bg-[#6D4C41]'}`}
              >
                <span className="font-black text-sm drop-shadow-md">D{d.day}</span>
                <span className="text-[10px] text-gray-200">{d.subTitle}</span>
              </button>
            ))}
            <button
               onClick={() => setShowInfo(true)}
               className={`flex-1 min-w-[70px] py-2 border-r border-[#4E342E] flex flex-col items-center justify-center
                  ${showInfo 
                    ? 'bg-white text-[#3E2723] shadow-[inset_0_-4px_0_#FFCC00]' 
                    : 'bg-gradient-to-b from-[#8D6E63] to-[#5D4037] text-[#DDD] hover:bg-[#6D4C41]'}`}
            >
              <span className="font-black text-sm drop-shadow-md">INFO</span>
              <span className="text-[10px] text-gray-200">ä½å®¿</span>
            </button>
          </div>

          {/* å…§å®¹å€åŸŸ */}
          <div className="bg-white min-h-[500px] p-4 flex flex-col">
            
            {showInfo ? (
              // Info Tab å…§å®¹ (æ‹‰åœ–æ–¯ + æ‰å¯¶ + èŠå¤©å®¤)
              <div className="text-center pt-2 animate-fade-in relative">
                {/* 1. æ‹‰åœ–æ–¯å€åŸŸ */}
                <div className="relative h-[220px] mb-4">
                     <div className="absolute top-0 left-1/2 -translate-x-1/2 text-[#d32f2f] text-3xl font-black z-10 font-serif drop-shadow-md" style={{textShadow: '2px 2px 0 #FFF'}}>
                        æµ·åº•æ’ˆæœˆ
                     </div>
                     <img src={ICONS.papulatus} className="w-[120px] absolute top-[45px] left-1/2 -translate-x-1/2 z-0" style={{animation: 'float 3s ease-in-out infinite'}} />
                     {/* æ‰å¯¶ */}
                     <img src={ICONS.chaosScroll} className="w-[45px] h-[45px] absolute top-[90px] left-[15%] z-10 drop-shadow-[0_0_5px_yellow]" style={{animation: 'bounceDrop 2s infinite'}} title="æ··æ²Œå·è»¸" />
                     <img src={ICONS.zakumHelm} className="w-[45px] h-[45px] absolute top-[70px] right-[15%] z-10 drop-shadow-[0_0_5px_yellow]" style={{animation: 'bounceDrop 2s infinite 0.5s'}} title="ç‚é­”é ­ç›”" />
                     <img src={ICONS.ilbi} className="w-[45px] h-[45px] absolute top-[150px] right-[25%] z-10 drop-shadow-[0_0_5px_yellow]" style={{animation: 'bounceDrop 2s infinite 1s'}} title="æ—¥ä¹‹é¢" />
                </div>

                {/* 2. èŠå¤©å®¤ */}
                <div className="bg-black/80 p-3 rounded text-left text-sm font-sans mb-4 border border-white/20 shadow-inner">
                    <div className="text-[#EE82EE] font-bold break-words">coward[é »é“228]:å››åœ‹é€£5 ç¼º1å¥³é¢è³Š ç›´æ¥ä¾† å…ˆåˆ°å…ˆæ‰“ è«‹è‡ªå‚™1 NB 1 VPN</div>
                    <div className="text-[#00FF00] font-bold mt-1">[å…¬æœƒè³‡è¨Šå·²æ›´æ–°]</div>
                    <div className="text-[#EE82EE] font-bold">beautyYang[é »é“6789]:sp4</div>
                    <div className="text-[#EE82EE] font-bold">LebronDogs[é »é“87]:ã„</div>
                    <div className="text-[#EE82EE] font-bold">camelCase[é »é“145]:CCCCCC</div>
                    <div className="text-[#EE82EE] font-bold">Mei[é »é“101]:101 é˜¿é–€</div>
                    <div className="text-[#00FF00] font-bold mt-1">[å…¬æœƒè³‡è¨Šå·²æ›´æ–°]</div>
                    <div className="text-[#EE82EE] font-bold">beautyYang[é »é“6789]:é‚„æˆ‘500è¬</div>
                    <div className="text-[#EE82EE] font-bold">LebronDogs[é »é“87]:ã„</div>
                </div>

                {/* 3. é£¯åº—å°èˆª */}
                <h2 className="text-2xl font-black text-[#333] mb-2">ğŸ  FAV HOTEL TAKAMATSU</h2>
                <button 
                  onClick={() => handleNavigate("https://www.google.com/maps/search/?api=1&query=FAV+HOTEL+TAKAMATSU")}
                  className="bg-gradient-to-b from-[#ff758c] to-[#ff7eb3] text-white w-full py-4 rounded-xl font-black text-xl shadow-[0_4px_0_#C2185B] border border-[#C2185B] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2"
                >
                  <img src={ICONS.returnScroll} className="w-8 h-8" />
                  å°èˆªå»é£¯åº—
                </button>
              </div>
            ) : (
              // æ—¥ç¨‹å…§å®¹
              <div className="animate-fade-in flex flex-col h-full">
                {/* 1. å¤©æ°£é¢æ¿ */}
                <RealWeather 
                  lat={currentData.lat} 
                  lng={currentData.lng} 
                  locationName={currentData.locationName} 
                />

                {/* 2. æ¨™é¡Œ */}
                <div className="mt-4 mb-4 border-b-2 border-dashed border-gray-300 pb-2">
                  <h2 className="text-xl font-black text-[#3E2723]">{currentData.title}</h2>
                  <p className="text-sm text-gray-500">{currentData.date}</p>
                </div>

                {/* 3. ç‰¹æ®Šåˆ‡æ›æŒ‰éˆ• (Day 3 & Day 4) */}
                {currentData.hasVariants && currentData.day === 3 && (
                  <div className="flex gap-2 mb-4 bg-gray-100 p-2 rounded-lg">
                    <button 
                      onClick={() => setDay3Mode('main')}
                      className={`flex-1 py-2 rounded font-bold text-sm transition-all ${day3Mode === 'main' ? 'bg-white shadow text-orange-600 border border-orange-200' : 'text-gray-400 hover:bg-gray-200'}`}
                    >
                      ğŸš¢ ä¸»ç·šï¼šå°è±†å³¶
                    </button>
                    <button 
                      onClick={() => setDay3Mode('backup')}
                      className={`flex-1 py-2 rounded font-bold text-sm transition-all ${day3Mode === 'backup' ? 'bg-white shadow text-purple-600 border border-purple-200' : 'text-gray-400 hover:bg-gray-200'}`}
                    >
                      ğŸ± å‚™ç”¨ï¼šç”·æœ¨å³¶
                    </button>
                  </div>
                )}
                {currentData.hasVariants && currentData.day === 4 && (
                  <div className="flex gap-2 mb-4 bg-gray-100 p-2 rounded-lg">
                    <button 
                      onClick={() => setDay4Mode('main')}
                      className={`flex-1 py-2 rounded font-bold text-sm transition-all ${day4Mode === 'main' ? 'bg-white shadow text-pink-600 border border-pink-200' : 'text-gray-400 hover:bg-gray-200'}`}
                    >
                      ğŸŒ¸ å€‰æ•·
                    </button>
                    <button 
                      onClick={() => setDay4Mode('backup')}
                      className={`flex-1 py-2 rounded font-bold text-sm transition-all ${day4Mode === 'backup' ? 'bg-white shadow text-yellow-600 border border-yellow-200' : 'text-gray-400 hover:bg-gray-200'}`}
                    >
                      â›©ï¸ é‡‘åˆ€æ¯”ç¾…(å‚™ç”¨)
                    </button>
                  </div>
                )}

                {/* 4. äº‹ä»¶åˆ—è¡¨ */}
                <ul className="space-y-4 mb-8">
                  {safeEvents.map((event, idx) => (
                    <li key={idx} className="border-b-2 border-dashed border-[#D7CCC8] pb-4 last:border-0">
                      <div className="flex items-center gap-2 mb-1">
                        <span className="bg-[#3E2723] text-[#FFD54F] border border-[#FFECB3] text-xs font-bold px-2 py-0.5 rounded shadow-sm min-w-[60px] text-center">
                          {event.time}
                        </span>
                        <h3 className="font-bold text-[#5D4037] text-lg flex items-center gap-2">
                          {event.title}
                          {event.icon === 'plane' && <span className="text-xl">âœˆï¸</span>}
                          {event.icon === 'boat' && <img src="https://cdn-icons-png.flaticon.com/512/2942/2942544.png" className="w-6 h-6 drop-shadow-sm" />}
                        </h3>
                      </div>
                      
                      {/* åœ–ç‰‡é¡¯ç¤ºå€ */}
                      {event.image && (
                         <div className="my-2 rounded-lg overflow-hidden border-2 border-gray-200 shadow-sm relative bg-gray-100 h-40">
                           <img 
                             src={event.image} 
                             alt={event.title} 
                             referrerPolicy="no-referrer"
                             className="w-full h-full object-cover" 
                             onError={(e) => {
                               e.target.onerror = null;
                               e.target.src = "https://placehold.co/800x400/87CEEB/white?text=A321neo";
                             }}
                           />
                         </div>
                      )}

                      <p className="text-gray-600 text-sm mb-3 pl-1 font-medium">{event.desc}</p>
                      
                      <div className="flex gap-2">
                        {event.link && (
                             <button 
                                onClick={() => handleNavigate(event.link)}
                                className="flex-1 bg-gradient-to-b from-[#FFF3E0] to-[#FFE0B2] text-[#E65100] border border-[#FF9800] shadow-[0_4px_0_#E65100] py-2 rounded-lg font-bold text-sm active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2"
                              >
                                <img src={ICONS.returnScroll} className="w-5 h-5" />
                                å°èˆª GO
                              </button>
                        )}
                        {/* æ»¿æ¿ƒå…¬åœ’é¡å¤–å°èˆª (for Day 3) */}
                        {event.title === "å‰å¾€ç”·æœ¨å³¶" && day3Mode === 'backup' && (
                             <button onClick={() => handleNavigate("https://maps.app.goo.gl/eeARXireyGCwiDNd9")} className="text-xs text-red-500 underline ml-2">æ»¿æ¿ƒ?</button>
                        )}
                      </div>
                    </li>
                  ))}
                </ul>

                {/* 5. NPC Note */}
                {currentData.note && (
                  <div className="mt-auto pt-4 pb-2">
                    <div className="bg-[#FFF8DC] border-2 border-[#DAA520] p-3 rounded-lg shadow-sm flex items-center gap-4 relative">
                       {/* è®“è‡è‡ç¨å¾®çªå‡ºä¸€é» */}
                       <img 
                         src={ICONS.mushroom} 
                         className="w-12 h-12 object-contain shrink-0 animate-bounce absolute -left-4 top-1/2 -translate-y-1/2" 
                         alt="npc" 
                       />
                       <p className="text-[#8B4513] text-sm font-bold leading-relaxed flex-1 pl-8">
                         {currentData.note}
                       </p>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      {/* åº•éƒ¨ç¶“é©—å€¼æ¢ / å»£æ’­ */}
      <ExpBar day={showInfo ? 6 : activeDay} isInfo={showInfo} />
    </>
  );
}
